<!DOCTYPE html>
<html>

<!-- punnett.html

Web interface for solving punnett squares
-->

<head>
  <title>Linnaeus</title>
  <link rel="stylesheet" type="text/css" href="css/main.css">
  <link rel="stylesheet" type="text/css" href="css/punnett.css">

  <!-- menu bar -->
  <script type="text/javascript" src="js/nav.js"></script>
  <!-- custom warning box -->
  <script type="text/javascript" src="js/warn.js"></script>
  <!-- table colorization scheme code -->
  <script type="text/javascript" src="js/colorize.js"></script>
</head>
<body>
  <div class="punnett-page">
    <div class="subtitle-text">
      <h1>Punnett Squares</h1>
    </div>
  </div>

  <!-- create table with html -->
  <script type="text/javascript">
    /* returns an HTML string with a table based on given data
       caller must supply a matching array of [R,G,B] colors to apply to the data */
    const colortbl = (data, colors) => {
      var html_str = '<table>';
      for (var r = 0; r < data.length; r++) {
        html_str += '<tr>';
        for (var c = 0; c < data.length; c++) {
          if (r == 0 || c == 0) {
            html_str += '<th>'+data[r][c].toString()+'</th>';
          } else {
            /* for data cells, pick background based on parallel color array */
            style = '';  // style defaults to nothing
            let percent = 100.0 / colors[r][c].length;
            style = 'background: linear-gradient(-45deg';
            for (let i = 0; i < colors[r][c].length; i++) {
              style += ','+colors[r][c][i].toString()+' '+(percent*i).toString()+'%,'
                          +colors[r][c][i].toString()+' '+(percent*(i+1)).toString()+'%';
            }
            style += ');';
            html_str += '<td style="'+style+'">'+data[r][c].toString()+'</td>';
          }
        }
        html_str += '</tr>'
      }
      html_str += '</table>'
      return html_str;
    }

    /* transforms a genotype string description into a 2D array, e.g.
       "AaBbCc" -> [["A", "a"], ["B", "b"], ["C", "c"]] */
    const str2geno = string =>
      string.split('')
            .map((el, i) => [el, string[i+1]])
            .filter((el, i) => i % 2 == 0);

    /* recursively determines the possible offspring for 2D genotype array */
    const combine = (arr, depth) => {
      if (depth == arr.length) {
        return [''];
      } else {
        var res = [];
        for (var i in arr[depth]) {
          var tmp = combine(arr, depth+1);
          for (var j in tmp) {
            res.push(arr[depth][i]+tmp[j]);
          }
        }
        return res;
      }
    }

    /* weaves two gentotype strings together, e.g.
       add("ABC", "abc") -> "AaBbCc" */
    const add = (f, m) =>
      f.split('').map((el, i) => el + m[i]).join('')

    const solve = (f, m) => {
      var f_arr = combine(str2geno(f), 0);
      var m_arr = combine(str2geno(m), 0);
      var sol_arr = [];
      for (var i in f_arr) {
        sol_arr.push([]);
        for (var j in m_arr) {
          sol_arr[i].push(add(f_arr[i], m_arr[j]));
        }
      }
      square = [[''].concat(m_arr)];
      for (var i in m_arr) {
        square.push([f_arr[i]].concat(sol_arr[i]));
      }
      return square;
    }

    var data = []; // expose data for easy CSV downloading later on
    const load_pun = () => {
      /* loads the punnett square */
      var father = document.getElementById('father').value;
      var mother = document.getElementById('mother').value;
      var title = document.getElementById('title').value;

      /* consider the right color mapping function (from colorize.js) to use */
      let cmap = {
        'none': color_blank,
        'uniques': color_uniques,
        'pairwise': color_pairwise
      }[document.getElementById('colorization').value];

      /* validate data */
      test = RegExp('^[a-zA-Z]{2,}$');
      if (father.length == mother.length && father.length % 2 == 0 &&
          test.test(father) && test.test(mother)) {
        data = solve(father, mother);
        let colors = [[]];
        // set first row of colors to blank
        for (let i = 0; i < data[0].length; i++)
          colors[0].push(color_blank());
        // set subsequent rows to a combined header and data
        let colorspace = sample_colors(Math.round(data[1][1].length / 2));
        for (let r = 1; r < data.length; r++) {
          colors.push([color_blank()]
                      .concat(data[r].slice(1)
                      .map(c => cmap(c, colorspace))));
        }
        let tbl = document.getElementById('pun-tbl');
        tbl.innerHTML = '<h3>'+title+'</h3>'+colortbl(data, colors);
      } else {
        warn_user('Error: invalid genotypes. Make sure that genotypes are'+
                  ' the same length and at most eight characters.' +
                  ' They must be of even length and contain only letters.');
      }
    }
  </script>

  <!-- usage information -->
  <div class="usage">
    <strong><i>Nota Bene!</i></strong> May take a long time for larger genotypes. Coloring is just for show and doesn't mean anything for now. Patience is a virtue.
  </div>
  <!-- basic entry fields -->
  <div id="entry">
    Father's genotype:
    <input id="father" type="text" name="father" value="Aa"><br>
    Mother's genotype:
    <input id="mother" type="text" name="mother" value="Aa"><br>
    Title:
    <input id="title" type="text" name="title" value="example"><br>
    Colorization:
    <select id="colorization" name="colorization">
      <option value="none">None</option>
      <option value="uniques">Uniques</option>
      <option value="pairwise">Pairwise</option>
    </select>
  </div>
  <div style="text-align: center; margin-top: 10px;">
    <button class="button" onclick="load_pun();">Solve Punnett Square</button>
    <button class="button" onclick="download_csv();" style="margin-left: 20px;">Download CSV</button>
  </div>
  <div id="warn-container" style="margin-top: 10px; text-align: center">
    <div id="alert" class="alert" style="display: none; width: 600px;"><strong style="color: #b73000;"><b>Error: </b></strong><span id="alert-text"></span><span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span></div>
  </div>
  <div id="pun-tbl" style="margin-top: 10px; text-align: center;"></div>

  <!-- just here for now -->
  <canvas id="canvas"></canvas> <!-- for downloading SVG => PNG -->
  <script type="text/javascript">
    const download_csv = () => {
      let table_as_str = data.map(row => row.join(",")).join("\n");
      let link = document.createElement("a");
      link.setAttribute("download", "linnaeus_punnett.csv");
      link.setAttribute("href", `data:application/octet-stream,${table_as_str}`);
      link.click();
    }
  </script>
</body>
</html>
