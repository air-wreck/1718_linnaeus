<!DOCTYPE html>
<html>

<!-- punnett.html

Web interface for solving punnett squares
-->

<head>
  <title>Linnaeus</title>
  <link rel="stylesheet" type="text/css" href="css/main.css">
  <link rel="stylesheet" type="text/css" href="css/punnett.css">

  <!-- menu bar for small screens -->
  <script type="text/javascript" src="js/nav.js"></script>
  <!-- custom warning box -->
  <script type="text/javascript" src="js/warn.js"></script>
  <!-- table colorization scheme code -->
  <script type="text/javascript" src="js/colorize.js"></script>

  <!-- Google fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans|Raleway|Rubik">
</head>
<body>
  <!-- navigation bar -->
  <div class="nav-bar">
    <ul>
      <div style="float: left;">
        <li><span><b>Linnaeus</b></span></li>
      </div>
      <div style="float: right;">
        <li><a href="home.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="pedigree.html">Pedigree</a></li>
        <li><a href="punnett.html">Punnett Square</a></li>
        <li><a href="contact.html">Contact</a></li>
      </div>
      <div style="float: right;" class="narrow-menu">
        <!-- this is such a sketchy way to make a menu button -->
          <button id="dropbtn">
            <div class="menu"></div>
            <div class="menu"></div>
            <div class="menu"></div>
          </button>

          <!-- the actual dropdown menu -->
          <div id="dropdown">
            <a href="Home.html">Home</a>
            <a href="about.html">About</a>
            <a href="pedigree.html">Pedigree</a>
            <a href="punnett.html">Punnett Square</a>
            <a href="contact.html">Contact</a>
          </div>
      </div>
    </ul>
  </div>
  <div class="punnett-page">
    <div class="subtitle-text">
      <h1>Punnett Squares</h1>
    </div>
  </div>

  <!-- create table with html -->
  <script type="text/javascript">
    const colortbl = (data, colors) => {
      /* return an html string with a table based on given data
         styling provided by caller, not callee

      Parameters:
        String[][] data : the data
        String[][][] colors : the colors --- please match the data array
      */

      var html_str = '<table>';
      for (var r = 0; r < data.length; r++) {
        html_str += '<tr>';
        for (var c = 0; c < data.length; c++) {
          if (r == 0 || c == 0) {
            html_str += '<th>'+data[r][c].toString()+'</th>';
          } else {
            /* for data cells, pick background based on parallel color array */
            style = '';  // style defaults to nothing
            let percent = 100.0 / colors[r][c].length;
            style = 'background: linear-gradient(-45deg'
            for (let i = 0; i < colors[r][c].length; i++) {
              style += ','+colors[r][c][i].toString()+' '+(percent*i).toString()+'%,'+colors[r][c][i].toString()+' '+(percent*(i+1)).toString()+'%';
            }
            style += ');';
            html_str += '<td style="'+style+'">'+data[r][c].toString()+'</td>';
          }
        }
        html_str += '</tr>'
      }
      html_str += '</table>'
      return html_str;
    }

    const str2geno = (string) => {
      var res = [];
      for (var i = 0; i < string.length; i += 2) {
        res.push([string[i], string[i+1]]);
      }
      return res;
    }

    const combine = (arr, depth) => {
      if (depth == arr.length) {
        return [''];
      } else {
        var res = [];
        for (var i in arr[depth]) {
          var tmp = combine(arr, depth+1);
          for (var j in tmp) {
            res.push(arr[depth][i]+tmp[j]);
          }
        }
        return res;
      }
    }

    const add = (f, m) => {
      ret = '';
      for (var i in f) {
        ret += f[i]+m[i];
      }
      return ret;
    }

    const solve = (f, m) => {
      var f_arr = combine(str2geno(f), 0);
      var m_arr = combine(str2geno(m), 0);
      var sol_arr = [];
      for (var i in f_arr) {
        sol_arr.push([]);
        for (var j in m_arr) {
          sol_arr[i].push(add(f_arr[i], m_arr[j]));
        }
      }
      square = [[''].concat(m_arr)];
      for (var i in m_arr) {
        square.push([f_arr[i]].concat(sol_arr[i]));
      }
      return square;
    }

    const load_pun = () => {
      /* loads the punnett square */
      var father = document.getElementById('father').value;
      var mother = document.getElementById('mother').value;
      var title = document.getElementById('title').value;

      /* consider the right color mapping function (from colorize.js) to use */
      let cmap = {
        'none': color_blank,
        'uniques': color_uniques,
        'pairwise': color_pairwise
      }[document.getElementById('colorization').value];

      /* validate data */
      test = RegExp('^[a-zA-Z]{2,}$');
      if (father.length == mother.length && father.length % 2 == 0 &&
          test.test(father) && test.test(mother)) {
        var data = solve(father, mother);
        var colors = [[]];
        // set first row of colors to blank
        for (let i = 0; i < data[0].length; i++)
          colors[0].push(color_blank());
        // set subsequent rows to a combined header and data
        let colorspace = sample_colors(Math.round(data[1][1].length / 2));
        for (let r = 1; r < data.length; r++) {
          colors.push([color_blank()]
                      .concat(data[r].slice(1)
                      .map((c) => cmap(c, colorspace))));
        }
        var tbl = document.getElementById('pun-tbl');
        tbl.innerHTML = '<h3>'+title+'</h3>'+colortbl(data, colors);
      } else {
        warn_user('Error: invalid genotypes. Make sure that genotypes are'+
                  ' the same length and at most eight characters.' +
                  ' They must be of even length and contain only letters.');
      }
    }
  </script>

  <!-- usage information -->
  <div class="usage">
    <strong><i>Nota Bene!</i></strong> May take a long time for larger genotypes. Coloring is just for show and doesn't mean anything for now. Patience is a virtue.
  </div>
  <!-- basic entry fields -->
  <div id="entry">
    Father's genotype:
    <input id="father" type="text" name="father" value="Aa"><br>
    Mother's genotype:
    <input id="mother" type="text" name="mother" value="Aa"><br>
    Title:
    <input id="title" type="text" name="title" value="example"><br>
    Colorization:
    <select id="colorization" name="colorization">
      <option value="none">None</option>
      <option value="uniques">Uniques</option>
      <option value="pairwise">Pairwise</option>
    </select>
  </div>
  <div style="text-align: center; margin-top: 10px;"><button class="button" onclick="load_pun();">Solve Punnett Square</button></div>
  <div id="warn-container" style="margin-top: 10px; text-align: center">
  <div id="alert" class="alert" style="display: none; width: 600px;"><strong style="color: #b73000;"><b>Error: </b></strong><span id="alert-text"></span><span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span></div>
  </div>
  <div id="pun-tbl" style="margin-top: 10px; text-align: center;"></div>

</body>
</html>
