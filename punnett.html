<!DOCTYPE html>
<!-- =============
File: punnett.html
Authors: Eric, Nelson, and Karena
Course: CSE
Description: web interface for manipulating and solving Punnett squares
============= -->

<html>
<head>
  <title>Linnaeus | Punnett Square</title>
  <meta charset="utf-8">
  <link rel="shortcut icon" type="image/png" href="img/png/l.png">
  <link rel="stylesheet" type="text/css" href="css/main.css">
  <link rel="stylesheet" type="text/css" href="css/punnett.css">

  <!-- menu bar -->
  <script type="text/javascript" src="js/nav.js"></script>
  <!-- custom JS styles -->
  <script type="text/javascript" src="js/pretty.js"></script>
  <!-- popup div -->
  <script type="text/javascript" src="js/popup.js"></script>
  <!-- table colorization scheme code -->
  <script type="text/javascript" src="js/colorize.js"></script>
  <!-- punnett square solving scripts -->
  <script type="text/javascript" src="js/pun_solve.js"></script>

  <!-- html2canvas to convert the HTML table to a downloadable PNG -->
  <script type="text/javascript" src="js/other/html2canvas.min.js"></script>
</head>
<body>
  <div class="punnett-page">
    <h1 style="font-weight: 100;">
      Welcome to Linnaeus: the online Punnett Square maker!
    </h1>
    <!-- button for help information -->
    <div style="position: absolute; left: 10px; top: 100px;">
      <a onclick="popup('popUpDiv')"
         onmouseover="this.parentNode.getElementsByTagName('span')[0]
                        .style.display='inline-block'"
         onmouseout="this.parentNode.getElementsByTagName('span')[0]
                        .style.display='none'"
         class="circle circle-red">?</a>
      <span class="circle-red help-flag">help</span>
    </div>
    <!-- button for usage information -->
    <div style="position: absolute; left: 10px; top: 130px;">
      <a onclick="(function (x) {x.style.display==='none'
                    ? x.style.display='block'
                    : x.style.display='none'}
                    (document.getElementById('usage-info')))"
         onmouseover="this.parentNode.getElementsByTagName('span')[0]
                        .style.display='inline-block'"
         onmouseout="this.parentNode.getElementsByTagName('span')[0]
                        .style.display='none'"
         class="circle circle-yellow">i</a>
      <span class="circle-yellow help-flag">info</span>
    </div>
  </div>

  <!-- hidden pop-up with help information -->
  <div id="blanket" style="display:none"></div>
  <div class="content-21" id="popUpDiv" style="display:none">
    <p><h2>How To Read a Punnett Square</h2>
    <ul>
      <li>The potential gamete genotypes of the father are displayed along the
        top of the square.</li><br>
      <li>The potential gamete genotypes of the mother are displayed along the
        left side.
      </li><br>
      <li>A capital letter indicates a dominant allele.</li><br>
      <li>A lowercase letter indicates a recessive allele.</li><br>
      <li>The cells in the square represent potential offspring genotypes
        generated by fusion of a father and a mother gamete.</li><br>
      <li>Coloring of the cells reflects the offspring phenotype; cells with
        the same color share the same phenotype.</li><br>
    </ul>
    </p>
    <a onclick="popup('popUpDiv')" ><center class="button">Close</center></a>
  </div>

  <!-- hidden text box with usage information -->
  <div id="usage-info" class="usage"
       style="text-align: center; display: none;">
    <strong>Usage Info:</strong> A 2x2 square supports multiple modes of
    inheritance. All other square sizes will default to autosomal
    inheritance.<br>To learn more about modes of inheritance, please visit our
    <a href="faq.html"><strong><u>FAQs</u></strong></a>.
  </div>

  <div style="text-align: center; font-weight: 100;">
    <br>Punnett Square Size:
  </div>

  <!-- buttons to choose size of square -->
  <div style="text-align: center; margin-top: 10px;">
    <button class="button" id="click-2"
            onclick="show(1);" style="margin-left: 20px;">
      2x2
    </button>
    <button class="button" id="click-4"
            onclick="show(2);" style="margin-left: 20px;">
      4x4
    </button>
    <button class="button" id="click-8"
            onclick="show(3);" style="margin-left: 20px;">
      8x8
    </button>
    <button class="button" id="click-16"
            onclick="show(4);" style="margin-left: 20px;">
      16x16
    </button>
  </div>

  <!-- user entry fields -->
  <div>
    <div id="data-father" class="data-entry">
      <span class="data-title">Father</span>
      <h1 id="father-entry" class="geno-entry">Aa</h1>
    </div>
    <div id="data-mother" class="data-entry">
      <span class="data-title">Mother</span>
      <h1 id="mother-entry" class="geno-entry">Aa</h1>
    </div>
  </div>

  <div style="text-align: center; margin-top: 10px;">
    <div id = "inherit2" style="display: none; font-size: 10pt;">
      Inheritance Mode:<br>
      <select id="colorization" name="colorization">
        <option value="autosomal">Autosomal</option>
        <option value="codominance">Codominance</option>
        <option value="incomplete">Incomplete</option>
      </select>
    </div>
    <div id = "inherit" style="display: none; font-size: 10pt;">
      Inheritance Mode:<br>
      <select id="colorization" name="colorization">
        <option value="autosomal">Autosomal</option>
      </select>
    </div>

    <!-- buttons for user interaction -->
    <button class="button"
            onclick="load_pun();"
            style="font-size: 10pt;">
      Solve Punnett Square
    </button>
    <button class="button"
            onclick="table_exists() && download_csv();"
            style="margin-left: 20px; font-size: 10pt;">
      Download CSV
    </button>
    <button class="button"
            onclick="table_exists() && download_png();"
            style="margin-left: 20px; font-size: 10pt;">
      Download PNG
    </button>
    <label id="upload-file-wrapper" style="margin-left: 20px;">
      <input type="file" id="csv-file"
             style="display: none;"
             oninput="upload_csv(event);">
      <span class="button" style="font-size: 10pt;">
        Upload CSV
      </span>
    </label>
  </div>
  <div id="warn-container">
    <div id="alert" class="alert">
      <strong style="color: #b73000;"><b>Error: </b></strong>
      <span id="alert-text"></span>
      <span class="closebtn"
            onclick="this.parentElement.style.display='none';">
        &times;
      </span>
    </div>
  </div>

  <div id="pun-tbl" style="margin: 10px 0; text-align: center;"></div>
  <div id="prob-tbl" style="margin: 10px 0; text-align: center;"></div>

  <script type="text/javascript">

    /* DISPLAY & DATA ENTRY FUNCTIONS */

    var current_display = 1; // curent number of traits being shown
    var texts = { // current father and mother genotypes
      "father": ["Aa", "Bb", "Cc", "Dd"],
      "mother": ["Aa", "Bb", "Cc", "Dd"]
    };

    // respond to a data entry
    const register_entry = (parent, geno) => {
      for (let i = 0; i < texts[parent].length; i++) {
        if (texts[parent][i].toUpperCase() === geno.toUpperCase())
          texts[parent][i] = geno;
      }
      let display = document.getElementById(`${parent}-entry`);
      display.textContent = texts[parent].slice(0, current_display).join("");
    }

    // set the entry fields to allow this many traits
    const show = size => {
      current_display = size;
      if (size === 1) {
        document.getElementById("inherit2").style.display = "inline-block";
        document.getElementById("inherit").style.display = "none";
      }
      else {
        document.getElementById("inherit2").style.display = "none";
        document.getElementById("inherit").style.display = "inline-block";
      }
      for (let i = 1; i < 5; i++) {
        if (i <= size) {
          ["father", "mother"].forEach(parent => {
            document.getElementById(`${parent}-wrap-${i}`).style.display =
              "block";
          });
        } else {
          ["father", "mother"].forEach(parent => {
            document.getElementById(`${parent}-wrap-${i}`).style.display =
              "none";
          });
        }
      }
      ["father", "mother"].forEach(parent => {
        let display = document.getElementById(`${parent}-entry`);
        display.textContent = texts[parent].slice(0, current_display).join("");
      });
    }

    // on page load, setup entry buttons
    window.addEventListener("load", _ => {
      ["father", "mother"].forEach(parent => {
        let entry = document.getElementById(`data-${parent}`);
        pretty.range(1, 5).forEach(n => {
          // make labels and buttons for traits 1-4
          let wrapper = document.createElement("div");
          wrapper.id = `${parent}-wrap-${n}`;
          wrapper.style.paddingTop = "10px";
          let label = document.createElement("span");
          label.textContent = `Trait ${n}:`;
          label.className = "data-title";
          wrapper.appendChild(label);
          ["XX", "Xx", "xx"].forEach(xx => {
            let geno = xx.split("")
              .map(x => x.toUpperCase() === x ? "upper" : "lower")
              .map(cap => pretty.alpha[cap][n-1]).join("");
            let button = document.createElement("button");
            button.className = "button button-entry";
            button.textContent = geno;
            button.addEventListener("click", event => {
              register_entry(parent, geno);
            });
            wrapper.appendChild(button);
          });
          entry.appendChild(wrapper);
        });
      });
      show(current_display);
    });


    /* SOLVING & TABLE MAKING FUNCTIONS */

    var data = []; // expose data for easy CSV downloading later on

    const make_prob_table = ordering => {
      // find the probabilities of the various genotypes by counting their
      //   occurrences in the solution matrix
      let genos = Array.prototype.concat(...data.map((row, i) => {
        if (i === 0) return [];
        return Array.prototype.concat(...row.map((cell, j) => {
          if (j === 0) return [];
          return [cell];
        }));
      }));
      let freq = genos.reduce((acc, x) => {
        if (Object.keys(acc).includes(x)) acc[x]++;
        else acc[x] = 1;
        return acc;
      }, {});

      let prob_tbl_html = Object.keys(freq)
        .map(key => [freq[key], `<tr><td>${key}</td><td>${(freq[key] /
          genos.length * 100).toFixed(2) + "%"}</td></tr>`])
        .sort((a, b) => ordering === "increasing"
          ? a[0] - b[0] : b[0] - a[0])
        .map(pair => pair[1]);
      let prob_tbl = document.createElement("table");
      let new_ordering = ordering === "increasing"
        ? "decreasing" : "increasing";
      prob_tbl.innerHTML =
        `<tr>
          <th>Genotype</th>
          <th id="flip-order">
            ${ordering === "decreasing" ? "&#x25BE;" : "&#x25B4;"}Probability
          </th>
        </tr>
        ${prob_tbl_html.join("")}`;
      document.getElementById("prob-tbl").innerHTML = prob_tbl.outerHTML;
      document.getElementById("flip-order").addEventListener("click", event => {
        make_prob_table(new_ordering);
      })
    }

    const load_pun = () => {
      /* loads the punnett square */
      let father = document.getElementById("father-entry").textContent;
      let mother = document.getElementById("mother-entry").textContent;

      /* consider the right color mapping function (from colorize.js) to use */
      let cmap = {
        "none":        colorize.color_blank,
        "autosomal":   colorize.color_autosomal,
        "codominance": colorize.color_codominance,
        "incomplete":  colorize.color_incomplete,
        "xlinked":     colorize.color_xlinked
      }[document.getElementById("colorization").value];

      data = pun_solve.solve(father, mother);
      let colors = [[]];
      // set first row of colors to blank
      colors[0] = data[0].map(_ => colorize.color_blank());
      // set subsequent rows to a combined header and data
      let colorspace = colorize.sample_colors(
        Math.round(data[1][1].length / 2));
      data.filter((_, i) => i > 0).forEach(datum =>
        colors.push([colorize.color_blank()]
                    .concat(datum.slice(1)
                    .map(c => cmap(c, colorspace)))));
      let tbl = document.getElementById("pun-tbl");
      tbl.innerHTML = colorize.colortbl(data, colors);
      make_prob_table("decreasing");
    }


    /* DOWNLOAD & UPLOAD FUNCTIONS */

    // check to see if there exists a rendered table before any downloads
    const table_exists = () => {
      if (document.getElementById("pun-tbl").innerHTML === "") {
        pretty.warn_user("No Punnett Square found");
        return false;
      }
      return true;
    }

    // download the punnett square as a CSV file for editing & re-upload
    const download_csv = () => {
      let table_as_str = data.map(row => row.join(",")).join("\n");
      let in_mode = document.getElementById("colorization").value;
      let link = document.createElement("a");
      link.setAttribute("download", `linnaeus_punnett_${in_mode}_data.csv`);
      console.log(link);
      link.setAttribute("href",
        `data:application/octet-stream,${table_as_str}`);
      link.click();
    }

    // download the punnett square as a PNG file for offline viewing
    const download_png = () => {
      let link = document.createElement("a");
      html2canvas(document.getElementById("punnett-table")).then(canvas => {
        link.setAttribute("download", "linnaeus_punnett_render.png");
        link.setAttribute("href",
          canvas.toDataURL().replace("image/png", "image/octet-stream"));
        link.click();
      });
    }

    // upload a CSV file (same format as download_csv)
    const upload_csv = event => {
      let file = event.target.files[0];
      let reader = new FileReader();
      reader.onload = e => {
        let csv = e.target.result;

        // check if valid
        let arr = csv.split("\n").map(row => row.split(","));
        if ((arr.length-1) % 2 !== 0) {
          pretty.warn_user("Invalid CSV file: bad column number");
          return -1;
        }
        let rowlen = arr.map(row => row.length);
        if (!rowlen.every(rl => rl === rowlen[0])) {
          pretty.warn_user("Invalid CSV file: bad row lengths");
          return -1;
        }

        // check number of rows for appropriate display method
        let num_rows = arr.length - 1;
        document.getElementById(`click-${num_rows}`).click();

        // figure out parent genotypes by looking at array
        let mother = ["Aa", "Bb", "Cc", "Dd"];
        for (let i = 2; i <= num_rows; i*=2) {
          let ind = Math.round(Math.log2(i)-1);
          let n = Math.round(num_rows/i + 1);
          mother[i/2-1] = arr[0][1][ind] + arr[0][n][ind];
        }
        texts["mother"] = mother;

        let father = ["Aa", "Bb", "Cc", "Dd"];
        for (let i = 2; i <= num_rows; i*=2) {
          let ind = Math.round(Math.log2(i)-1);
          let n = Math.round(num_rows/i + 1);
          father[i/2-1] = arr[1][0][ind] + arr[n][0][ind];
        }
        texts["father"] = father;

        show(Math.round(Math.log2(num_rows)));

        // re-solve the punnett square
        // this relies on the filename to identify inheritance mode
        let c_scheme = file.name.split("_")[2];
        document.getElementById("colorization").value = c_scheme;
        load_pun();
      }
      reader.readAsText(file);
    }
  </script>
</body>
</html>
