#!/usr/bin/env python

# these imports will not work until /setup.sh is run
# you can include cgitb for pretty errors, but that's not necessary
import os, urllib2, re, allele

# retrieve and parse HTTP GET request
query = [i.split('=')[1] for i in os.getenv('QUERY_STRING').split('&')]
father = query[0]
mother = query[1]
title = ''
if len(query) > 2:
    title = urllib2.unquote(query[2])

# validate data on server-side
test = re.compile('^[a-zA-Z]{2,8}$')
if (not bool(test.match(father)) or not bool(test.match(mother)) or
   len(father) != len(mother) or len(father) % 2 == 1):
    # I'm not sure if it's valid to return another Content-Type on error, but
    # this should never be reached by a *legitimate* user anyway
    print 'Content-Type: text/html'
    print ''
    print 'Error: invalid query'
else:
    # plot the punnett square
    psquare = allele.plot(father, mother, title=title)
    psquare.color(1, 1, c1='#a4c4fc')
    psquare.color(2, 2, c1='#fcaba4')
    psquare.color(1, 2, c1='#fcaba4', c2='#a4c4fc')
    psquare.color(2, 1, c1='#fcaba4', c2='#a4c4fc')

    # print the image to stdout
    print 'Content-Type: image/png'
    print ''
    print psquare.to_png()
